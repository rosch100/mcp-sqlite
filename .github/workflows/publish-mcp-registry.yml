name: Publish to MCP Registry

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.2.4)'
        required: false

env:
  REGISTRY_URL: https://registry.modelcontextprotocol.io

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for GitHub OIDC
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Extract version from tag or input
      id: version
      run: |
        if [ "${{ github.event_name }}" == "release" ]; then
          VERSION="${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present
          VERSION=${VERSION#v}
        else
          VERSION="${{ github.event.inputs.version }}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Publishing version: $VERSION"
    
    - name: Validate server.json
      run: |
        if ! command -v jq &> /dev/null; then
          sudo apt-get update && sudo apt-get install -y jq
        fi
        echo "Validating server.json..."
        jq . server.json > /dev/null
        echo "‚úÖ server.json is valid JSON"
        
        # Check if version matches
        SERVER_VERSION=$(jq -r '.version' server.json)
        echo "Server.json version: $SERVER_VERSION"
        echo "Release version: ${{ steps.version.outputs.version }}"
    
    - name: Install mcp-publisher
      run: |
        echo "Installing mcp-publisher..."
        set -e  # Exit on error
        
        # Download binary directly (GitHub Actions runs on Ubuntu, no brew)
        ARCH=$(uname -m)
        OS=$(uname -s | tr '[:upper:]' '[:lower:]')
        if [ "$ARCH" = "x86_64" ]; then
          ARCH="amd64"
        elif [ "$ARCH" = "aarch64" ]; then
          ARCH="arm64"
        fi
        
        VERSION="1.3.10"
        # URL format: mcp-publisher_linux_amd64.tar.gz (no version in filename)
        URL="https://github.com/modelcontextprotocol/registry/releases/download/v${VERSION}/mcp-publisher_${OS}_${ARCH}.tar.gz"
        
        echo "Detected OS: $OS, Arch: $ARCH"
        echo "Downloading mcp-publisher v${VERSION} from $URL"
        
        # Download with error checking
        if ! curl -Lf "$URL" -o mcp-publisher.tar.gz; then
          echo "‚ùå Failed to download mcp-publisher from $URL"
          echo "Trying latest release..."
          # Try latest release
          LATEST_URL="https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_${OS}_${ARCH}.tar.gz"
          if ! curl -Lf "$LATEST_URL" -o mcp-publisher.tar.gz; then
            echo "‚ùå Alternative download also failed"
            exit 1
          fi
          echo "‚úÖ Downloaded from latest release"
        fi
        
        # Verify download
        if [ ! -f mcp-publisher.tar.gz ]; then
          echo "‚ùå Download file not found"
          exit 1
        fi
        
        echo "Extracting mcp-publisher..."
        tar -xzf mcp-publisher.tar.gz
        
        # Find the binary (might be in subdirectory or root)
        if [ -f mcp-publisher ]; then
          BINARY_PATH="./mcp-publisher"
        elif [ -f "./mcp-publisher_${OS}_${ARCH}/mcp-publisher" ]; then
          BINARY_PATH="./mcp-publisher_${OS}_${ARCH}/mcp-publisher"
        else
          echo "‚ùå mcp-publisher binary not found after extraction"
          echo "Contents of current directory:"
          ls -la
          echo "Looking for mcp-publisher..."
          find . -name "mcp-publisher" -type f 2>/dev/null || true
          exit 1
        fi
        
        chmod +x "$BINARY_PATH"
        sudo mv "$BINARY_PATH" /usr/local/bin/mcp-publisher
        
        # Verify installation
        if ! command -v mcp-publisher &> /dev/null; then
          echo "‚ùå mcp-publisher not found in PATH after installation"
          exit 1
        fi
        
        echo "‚úÖ mcp-publisher installed successfully"
        mcp-publisher --version
    
    - name: Authenticate with MCP Registry
      run: |
        echo "Authenticating with MCP Registry using GitHub OIDC..."
        mcp-publisher login github-oidc
        echo "‚úÖ Authentication successful"
    
    - name: Wait for Docker image to be available
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        IMAGE_NAME="${{ github.repository }}"
        MAX_ATTEMPTS=30
        ATTEMPT=0
        
        echo "Waiting for Docker image to be available: ghcr.io/${IMAGE_NAME}:${VERSION}"
        echo "This may take a few minutes while the Docker build completes..."
        
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          ATTEMPT=$((ATTEMPT + 1))
          echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Checking if image exists..."
          
          # Check if image exists using GitHub Container Registry API
          # Note: This checks if the package version exists
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/users/${{ github.repository_owner }}/packages/container/${IMAGE_NAME#*/}/versions" || echo "000")
          
          if [ "$HTTP_CODE" = "200" ]; then
            # Check if specific version tag exists in the versions list
            VERSIONS=$(curl -s \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/users/${{ github.repository_owner }}/packages/container/${IMAGE_NAME#*/}/versions" | \
              jq -r ".[].metadata.container.tags[]" 2>/dev/null || echo "")
            
            if echo "$VERSIONS" | grep -q "^${VERSION}$"; then
              echo "‚úÖ Docker image ghcr.io/${IMAGE_NAME}:${VERSION} is now available!"
              break
            fi
          fi
          
          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "‚ö†Ô∏è  Docker image not found after $MAX_ATTEMPTS attempts (5 minutes)"
            echo "The Docker build may still be in progress."
            echo "Continuing anyway - if publish fails, wait for Docker build to complete and retry."
          else
            echo "Image not yet available, waiting 10 seconds..."
            sleep 10
          fi
        done
    
    - name: Publish to MCP Registry
      id: publish
      run: |
        echo "Publishing to MCP Registry..."
        echo "Server name from server.json:"
        jq -r '.name' server.json
        echo "Repository URL:"
        jq -r '.repository.url' server.json
        echo "Version:"
        jq -r '.version' server.json
        
        # Try to publish with verbose output
        if mcp-publisher publish --verbose 2>&1; then
          echo "‚úÖ Successfully published to MCP Registry"
          echo "published=true" >> $GITHUB_OUTPUT
        else
          EXIT_CODE=$?
          echo "‚ùå Failed to publish to MCP Registry (exit code: $EXIT_CODE)"
          echo "published=false" >> $GITHUB_OUTPUT
          
          # Note about repository rename
          echo ""
          echo "Note: This server uses the new name after repository rename:"
          echo "Old name: io.github.rosch100/mcp-sqlite"
          echo "New name: io.github.rosch100/mcp-encrypted-sqlite"
          echo ""
          echo "The server will be published as a NEW entry with the new name."
          echo "The old entry (mcp-sqlite) will remain in the registry."
          echo ""
          echo "If the error was about missing Docker image, wait for the Docker build"
          echo "to complete and then manually trigger this workflow again."
          
          exit $EXIT_CODE
        fi
    
    - name: Verify publication
      if: steps.publish.outputs.published == 'true'
      run: |
        SERVER_NAME=$(jq -r '.name' server.json)
        echo "Verifying publication for: $SERVER_NAME"
        
        # Wait a moment for registry to update
        sleep 5
        
        # Try to verify via API (if available)
        if curl -s "${REGISTRY_URL}/v0/servers?search=${SERVER_NAME}" | grep -q "${SERVER_NAME}"; then
          echo "‚úÖ Server found in registry"
        else
          echo "‚ö†Ô∏è  Could not verify via API, but publish succeeded"
        fi
    
    - name: Create GitHub Issue for manual submissions
      if: steps.publish.outputs.published == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const version = '${{ steps.version.outputs.version }}';
          const releaseUrl = '${{ github.event.release.html_url }}';
          
          const body = `## Release ${version} Published to MCP Registry ‚úÖ
          
          The server has been automatically published to the official MCP Registry.
          
          ### Manual Submissions Required
          
          Please submit this release to the following community directories:
          
          - [ ] **MCPList.ai** - Use [MCPLIST_SUBMISSION.md](https://github.com/${{ github.repository }}/blob/main/MCPLIST_SUBMISSION.md)
          - [ ] **MCP Index** - Use [MCPINDEX_SUBMISSION.md](https://github.com/${{ github.repository }}/blob/main/MCPINDEX_SUBMISSION.md)
          - [ ] **MCPServ.club** - Use [MCPSERV_SUBMISSION.md](https://github.com/${{ github.repository }}/blob/main/MCPSERV_SUBMISSION.md)
          - [ ] **Directory MCP** - Use [DIRECTORY_MCP_SUBMISSION.md](https://github.com/${{ github.repository }}/blob/main/DIRECTORY_MCP_SUBMISSION.md)
          - [ ] **MCPHub** - Use [MCPHUB_SUBMISSION.md](https://github.com/${{ github.repository }}/blob/main/MCPHUB_SUBMISSION.md)
          
          ### Release Information
          - **Version**: ${version}
          - **Release**: ${releaseUrl}
          - **Docker Image**: ghcr.io/${{ github.repository }}:${version}
          
          ### Submission Templates
          All submission templates are available in the repository root directory.
          
          ---
          
          *This issue was automatically created by the publish-mcp-registry workflow.*`;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `üì¢ Manual Submission Required for Release ${version}`,
            body: body,
            labels: ['release', 'documentation', 'help wanted']
          });

